{% extends 'base.html' %}

    {% load static %}
    {% block head %}
    <title>Letter Search - Upload</title>

    {% endblock %}


    {% block hr %}
    <script src="{% static "db/script.js" %}"></script>
    <div class="header-right">
        <a href="{% url 'db:index' %}">Home</a>
        <a href="{% url 'db:search' %}">Search</a>
        <a class="active" href="{% url 'db:upload' %}">Upload</a>
        <a href="{% url 'db:labels' %}">Metadata</a>
        <a onclick="return logout();" id="logout">Logout</a>
    </div>
    {% endblock %}

    {% block body %}
    <div class="main">
    <div class="searchheader" id="upddisp">
        <h1>Upload your file!</h1>
        <p>We only accept Word documents (.docx) and Excel documents (.xlsx or .xls)</p>
        <form action="{% url 'db:upload' %}" method="POST" id="uploadfield" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="custom-file-upload">
                <button class="bt-upload">Select a file</button>
                <input type="file" name="myfile" id="updfile"></input>
            </div>
            <div id="file-upload-name"></div>
            <button class="bt-submit" type="submit" id="scanfile"> Preview file</button>
            <button class="bt-discard" type="button" onclick="mydiscard()">Discard file</button>
        </form>
        {% if not list and request.method == 'POST' %}
            <br>
            <!-- Error message for storing, previewing, or wrong file selection -->
            {% if errtype == 'store' %}
                <div> {{err}} </div>
            {% elif errtype == 'preview' %}
                {% if err != '' %}
                    <div> {{err}} of the given file: <b><i>{{fname}}</i></b></div>
                    <div> Refer to the guide below for ideal format of a letter.</div>
                {% else %}
                    <div id="errmsg">Selected file <b><i>{{fname}}</i></b> is either empty or has a wrong format.</div>
                    <div> Refer to the guide below for ideal format of a letter.</div>
                {% endif %}
            {% else %}
                <div id="errmsg">Selected file <b><i>{{fname}}</i></b> is either empty or has a wrong format.</div>
                <div> Refer to the guide below for ideal format of a letter.</div>
            {% endif %}
        {% endif %}
    </div>
  </div>

    {% if not list %}
        {% if request.method == 'GET' or request.method == 'POST' %}
        <div class="main" style="min-height:300px;background-color:rgb(250, 250, 250)">
            <h2>How to upload spreadsheets</h2>
            {% load staticfiles %}
            <!-- <img src="{% static "db/favicon-b.png" %}" alt="My image"/> -->
            <img src="{% static 'db/excel_template.png'%}" class="excel-img" style="">
            <!-- <p style="text-align:left;"><img src="{% static 'db/excel_template.png'%}" style="width:400px;"/></p> -->
            <!-- <img style="width:2.4rem; float:left; margin-left: 0.7rem; margin-right: 0.3rem; margin-top: 0.45rem;" src="{% static 'db/excel-template.png' %}"/> -->
            <div class="instructions">
            <h4>Steps</h4>
            <p>When uploading spreadsheets to the website, ensure you always have a column for archive number, this should be a unique identification number for each historical document. Some example data has been included to give a general understanding of what can be uploaded. If you wish to store additional information you may create additional columns, each new column must have a header describing what information the column contains.</p>
            <p><a href="{% static 'db/template-excel-sheet.xlsx'%}">Download template spreadsheet.</a></p>
        </div>
        </div>
        <div class="main" style="margin-bottom:5rem;min-height:350px;clear: both;background-color:rgb(250, 250, 250)">
        <h2>How to upload word documents</h2>
        {% load staticfiles %}
        <!-- <img src="{% static "db/favicon-b.png" %}" alt="My image"/> -->
        <img src="{% static 'db/word_template.png'%}" class="excel-img">
        <!-- <p style="text-align:left;"><img src="{% static 'db/excel_template.png'%}" style="width:400px;"/></p> -->
        <!-- <img style="width:2.4rem; float:left; margin-left: 0.7rem; margin-right: 0.3rem; margin-top: 0.45rem;" src="{% static 'db/excel-template.png' %}"/> -->
        <div class="instructions">
        <h4>Steps</h4>
        <p>
            When uploading a word document to the website, ensure you always have the correct formatting according to the following example template. A unique identification number is needed for each historical document. Each document must be separated by a unique number.
            Some example data has been included to give a general understanding of what can be uploaded.
        </p>
        <p><a href="{% static 'db/Word_example.docx'%}">Download example word doc.</a></p>

        </div>
        </div>
        {% endif %}
    {% endif %}


    {% if list %}
        <div class="main" style="margin-bottom:5rem;margin-top:0rem;" id="datapreview">
        {% if list %}
            {% if fname %}
                <div id="scanfname"> <b>Scanned file:</b> <i>{{fname}}</i> </div>
            {% endif %}

            <br>
            <div class="preview-results" id="prevresults">
                <!-- excel files -->
                {% if indic == 1 %}
                    <h2 class="code">Data Preview</h2>
                    {% for letter in list %}
                    <table>
                        {% for i in letter %}
                        <tr>
                        {% for j in i %}
                            <th>{{j.1}}</th>
                        {% endfor %}
                        </tr>
                        {% endfor %}
                    </table>
                    {% endfor %}
                {% endif %}

                <!-- Docx files -->
                {% if indic == 0 %}
                    <h2 class="code">Data Preview</h2>
                    <table id="previewtable">
                    {% for letter in list %}
                    <tr>
                    {% if forloop.counter0 == 0 %}
                        {% for i in letter %}
                            <th>{{i.1}}</th>
                        {% endfor %}
                    {% else %}
                        {% for i in letter %}
                            <th>{{i.1}}</th>
                        {% endfor %}
                        <!-- <th> <button type="submit" onclick="show_index('{{forloop.counter0}}')"> Edit</button></th> -->
                        {% endif %}
                        {% endfor %}
                    </tr>
                    </table>
                {% endif %}
            </div>
        {% endif %}

        <p style="padding:0 15% 0"><i>If you wish to add <b>{{fname}}</b> to the search engine for future results please press:<br> 'Add document to database'<br>otherwise press 'Discard file' above.</i></p>
        <form action = "{% url 'db:index' %}" method = "POST" id = "input_field" class = "input_form">
            {% csrf_token %}
            <button class="bt-add" id="commit-button" type="submit" name = "input_file" style="margin-bottom:0px;" onclick="addToDb()">Add document to database</button>
        </form>
    {% endif %}

    <script>
        var inputfile = document.getElementById("updfile");
        var scanfile = document.getElementById("scanfile");
        var infoArea = document.getElementById("file-upload-name");

        function mydiscard() {
            var url = location.href;
            var base = url.split('db')[0];
            url = base + "db/upload";
            location.href = url;
        }

        inputfile.addEventListener("change", showFileName);
        scanfile.addEventListener("click", checkFile);

        function showFileName( event ) {
            var input = event.srcElement;
            var fileName = input.files[0].name;
            infoArea.textContent = "File selected: " + fileName;
        }
        function checkFile( event ) {
            if (inputfile.files.length == 0){
                alert("No file is selected for scanning!");
            }
        }

        // Function below are for edit functionality when data is previewed
        // This is for future work/implementation
        // function show_index(row_number)
        // {
        //     var table = document.getElementById("previewtable");
        //     var each_row = table.rows[row_number].getElementsByTagName("th");
        //     for(var ic = 0 ; ic < each_row.length ; ic++)
        //     {
        //         var currentcell = table.rows[row_number].cells[ic];
        //         // Doesnt convert the edit button into textbox
        //         if( currentcell.childNodes.length > 1){
        //             if(currentcell.childNodes[1].nodeName == "BUTTON"){
        //                 currentcell.childNodes[1].innerHTML = "Save";
        //                 currentcell.childNodes[1].setAttribute('onclick','show_change('+row_number+')');
        //                 continue;
        //             }
        //         }
        //         // Changes everything else into textbox
        //         var text = each_row[ic].innerHTML;
        //         var a = document.createElement('input');
        //         a.setAttribute("value",text);
        //         currentcell.innerHTML = '';
        //         currentcell.append(a);
        //     }
        // }

        // function show_change(row_number){
        //     var reslong = "{{list|length}}";
        //     var letters = 0;
        //     var table = document.getElementById("previewtable");
        //     var each_row = table.rows[row_number].getElementsByTagName("th");
        //     for (letters=0; letters < reslong ; letters++){
        //         var letterlen =  "{{list.|add:"+letters+"|length}}";
        //     }
        //     for(var ic = 0 ; ic < each_row.length ; ic++)
        //     {
        //         var currentcell = table.rows[row_number].cells[ic];
        //         // Convert save button back to edit button
        //         if( currentcell.hasChildNodes()){
        //             if (currentcell.childNodes.length > 1){
        //                 if(currentcell.childNodes[1].nodeName == "BUTTON"){
        //                     currentcell.childNodes[1].innerHTML = "Edit";
        //                     currentcell.childNodes[1].setAttribute('onclick','show_index('+row_number+')');
        //                     break;
        //                 }
        //             }
        //         }
        //         // Changes everything back to text
        //         var text = currentcell.childNodes[0].value;
        //         // for (var k = 0 ; k < resultarr.length ; k++){
        //         //     // resultarr[row_number][k][1] = text;
        //         //     alert(resultarr[k]);
        //         // }
        //         currentcell.removeChild(currentcell.childNodes[0]);
        //         currentcell.append(text);
        //     }
        // }
    </script>
    {% endblock %}
</div>
